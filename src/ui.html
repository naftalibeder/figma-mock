<style type="text/css">
  html {
    font-family: Verdana, Geneva, Tahoma, sans-serif;
  }
  body {
    padding-left: 8px;
    padding-right: 8px;
  }
  h2 {
    font-size: 12;
    padding-top: 8px;
  }
  p, div, input, label, textarea {
    font-size: 11;
  }
  .buttons {
    display: inline-flex;
    flex-wrap: wrap;
    justify-content: space-between;
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 16px;
    gap: 16px;
  }
  button {
    flex: 1;
    height: 40px;
    font-size: 11;
    border-width: 0;
  }
  button:hover {
    background-color: rgb(221, 221, 221);
  }
  button.primary {
    background-color: rgb(98, 140, 255);
    color: white;
  }
  button.primary:hover {
    background-color: rgb(75, 112, 214);
  }
  select {
    width: 100%;
    padding: 8px;
  }
  textarea {
    resize: none;
    width: 100%;
    padding: 8px;
    margin-bottom: 8px;
  }
  #input-textbox {
    margin-top: 8px;
  }
</style>

<body>
  <link rel="stylesheet" href="main.css" />

  <h2>Output</h2>
  <p>Choose the group of text fields to fill.</p>
  <select id="nodes-dropdown"></select>

  <h2>Input</h2>
  <p>Choose a type of data to paste into the selected fields.</p>
  <input type="text" id="input-repo-textbox" placeholder="Url to index.json file" value="https://raw.githubusercontent.com/TruckMap/truckmap-figma/main" />
  <select id="input-dropdown" onchange="onChangeInputKind()"></select>
  <textarea id="input-textbox" rows="5"></textarea>

  <h2>Options</h2>
  <input type="checkbox" id="randomize-checkbox" checked='true'>
  <label for="randomize">Randomize</label><br>

  <br>

  <div class='buttons'>
    <button id="cancel">Cancel</button>
    <button id="confirm" class='primary'>Paste</button>
  </div>
</body>

<script>
  const inputRepoTextbox = document.getElementById('input-repo-textbox');
  const inputDropdown = document.getElementById('input-dropdown');
  const nodesDropdown = document.getElementById('nodes-dropdown');

  onmessage = event => {
    const msg = event.data.pluginMessage;

    [...inputDropdown.children].forEach(child => inputDropdown.removeChild(child));
    [...nodesDropdown.children].forEach(child => nodesDropdown.removeChild(child));

    if (msg.type === 'init') {
      const baseUrl = inputRepoTextbox.value;
      fetch(`${baseUrl}/index.json`, (response) => {
        const lists = JSON.parse(response).lists;
        lists.forEach((list, index) => {
          const inputOption = document.createElement('option');
          inputOption.id = `input-option-${index}`;
          inputOption.innerHTML = list.name;
          inputOption.dataset.url = `${baseUrl}/${list.path}`;
          inputDropdown.appendChild(inputOption);
        });
      });

      const nodeGroups = msg.nodeGroups;
      nodeGroups.forEach((nodeGroup, i) => {
        const nodes = Object.values(nodeGroup.nodesMap);
        const nodeGroupTexts = [...new Set(nodes.map(o => o.characters.slice(0, 20)))];
        const fieldCountDisplay = `(${nodeGroupTexts.length} fields)`;
        const nodesDisplayText = `${nodeGroupTexts[0]}${nodeGroupTexts.length > 1 ? ', ...' : ''}${nodeGroupTexts.length > 1 ? ' ' + fieldCountDisplay : ''}`;
        // const nodesDisplayText = nodeGroupTexts.slice(0, 3).join(', ');

        const nodeOption = document.createElement('option');
        nodeOption.value = nodeGroup.key;
        nodeOption.innerHTML = nodesDisplayText;
        if (i === 0) nodeOption.selected = true;
        nodesDropdown.appendChild(nodeOption);
      });

      onChangeInputKind(); // Forces update.
    } else if (msg.type === 'clear') {
      [...inputDropdown.children].forEach(child => inputDropdown.removeChild(child));
      [...nodesDropdown.children].forEach(child => nodesDropdown.removeChild(child));
    }
  };

  function onChangeInputKind() {
    const listTextbox = document.getElementById('input-textbox');

    const inputDropdown = document.getElementById('input-dropdown');
    const inputDropdownOptions = [...inputDropdown.children];
    const selectedInputDropdownOption = inputDropdownOptions.filter(o => o.selected == true)[0];

    if (selectedInputDropdownOption?.id == 'custom') {
      listTextbox.hidden = false;
      listTextbox.placeholder = 'Enter a url to a newline-separated text list, or paste one directly.';
      listTextbox.innerHTML = '';
    } else {
      listTextbox.hidden = true;
    }
  }

  document.getElementById('confirm').onclick = () => {
    const inputTextbox = document.getElementById('input-textbox');

    const inputDropdown = document.getElementById('input-dropdown');
    const inputDropdownOptions = [...inputDropdown.children];
    const selectedInputDropdownOption = inputDropdownOptions.filter(o => o.selected == true)[0];

    const nodesDropdown = document.getElementById('nodes-dropdown');
    const nodesDropdownOptions = [...nodesDropdown.children];
    const selectedNodeDropdownOption = nodesDropdownOptions.filter(o => o.selected == true)[0];
    
    const randomize = document.getElementById('randomize-checkbox').checked;

    console.log('Selected:', selectedInputDropdownOption.id);

    const config = {
      type: 'confirm',
      items: [],
      groupingKey: selectedNodeDropdownOption.value,
      randomize,
    };

    let inputUrl = null;
    let inputText = null;

    if (selectedInputDropdownOption.id === 'custom') {
      if (inputTextbox.value.match(/.+\.txt/)) {
        inputUrl = inputTextbox.value;
      } else {
        inputText = inputTextbox.value;
      }
    } else {
      inputUrl = selectedInputDropdownOption.dataset.url;
    }

    if (inputUrl) {
      console.log('Fetching:', inputUrl);
      fetch(inputUrl, (response) => {
        const items = itemsFromStr(response);
        parent.postMessage({ pluginMessage: { ...config, items } }, '*');
      });
    } else if (inputText) {
      console.log('Pasting:', inputText);
      const items = itemsFromStr(inputText);
      parent.postMessage({ pluginMessage: { ...config, items } }, '*');
    }
  };

  document.getElementById('cancel').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
  };

  function fetch(url, onResponse) {
    let request = new XMLHttpRequest();
    request.open('GET', url);
    request.responseType = 'text';
    request.onload = () => onResponse(request.response);
    request.send();
  }

  function itemsFromStr(str) {
    return str.split('\n').filter(line => line.length > 0);
  }

  parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
</script>