<style type="text/css">
  html {
    font-family: Verdana, Geneva, Tahoma, sans-serif;
  }
  body {
    padding-left: 8px;
    padding-right: 8px;
  }
  h2 {
    font-size: 12;
    padding-top: 8px;
  }
  p, div, input, label, textarea {
    font-size: 11;
  }
  p.error {
    color: rgb(218, 80, 103);
  }
  p.meta {
    font-size: 9;
    color: rgb(83, 83, 83);
  }
  .overlay {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    padding-left: 16px;
    padding-right: 16px;
    background-color: white;
  }
  .buttons {
    display: inline-flex;
    flex-wrap: wrap;
    justify-content: space-between;
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 16px;
    gap: 8px;
    background-color: white;
  }
  button {
    flex: 1;
    height: 40px;
    font-size: 11;
    border-width: 0;
  }
  button:hover {
    background-color: rgb(221, 221, 221);
  }
  button.primary {
    background-color: rgb(98, 140, 255);
    color: white;
  }
  button.primary:hover {
    background-color: rgb(75, 112, 214);
  }
  button.link {
    background: none;
    border: none;
    height: auto;
    padding: 0;
    color: rgb(75, 112, 214);
    text-decoration: underline;
    cursor: pointer;
  }
  button:disabled {
    background-color: lightgray;
    color: gray;
  }
  select {
    width: 100%;
    padding: 8px;
  }
  textarea {
    resize: none;
    width: 100%;
    padding: 8px;
  }
  .vertical-list {
    display: flex;
    flex: 1;
    flex-direction: column;
    gap: 8px;
  }
  .vertical-list-item {
    flex: 1;
  }
  .horizontal-list {
    display: flex;
    flex-wrap: nowrap;
    box-sizing: border-box;
    justify-content: space-between;
    gap: 4px;
  }
  .horizontal-list-item {
    width: 100%;
  }
  .vertical-item-and-text {
    display: flex;
    flex-wrap: nowrap;
    box-sizing: border-box;
    justify-content: space-between;
    flex-direction: column;
    gap: 8px;
  }
  .horizontal-item-and-text {
    flex-direction: row;
    flex-wrap: nowrap;
    align-items: flex-start;
    justify-content: center;
  }
  input[type=checkbox] {
    width: 14;
    height: 14;
  }
  input[type=text] {
    height: 40px;
    width: 100%;
    padding: 8px;
  }
  input[type=number] {
    height: 40px;
    width: 100%;
    padding: 8px;
  }
  input[type=date] {
    height: 40px;
    width: 100%;
  }
  pre {
    font-family: monospace;
    background-color: rgb(231, 231, 231);
    overflow-x: scroll;
    overflow-y: hidden;
    padding: 16px;
  }
  .margin-above {
    margin-top: 8px;
  }
</style>

<body>
  <div style="padding-bottom: 60px;">
    <h2>Output</h2>
    <p>Choose the group of text fields to fill.</p>
    <select id="nodes-dropdown"></select>

    <h2>Input</h2>
    <p>Choose a type of data to paste. <button id="settings-button" class='link'>Edit lists</button></p>
    <select id="input-dropdown"></select>

    <h2>Options</h2>
    <div id='options-section-strings'>
      <p>Capitalization</p>
      <select id="casing-dropdown">
        <option value="none">Use original</option>
        <option value="sentence">Sentence case</option>
        <option value="title">Title case</option>
        <option value="upper">Upper case</option>
        <option value="lower">Lower case</option>
      </select>
      <div class='horizontal-item-and-text margin-above'>
        <input id="randomize-checkbox" type="checkbox" checked='true' />
        <label for="randomize-checkbox">Randomize</label><br>
      </div>
    </div>
    <div id='options-section-numbers'>
      <div class='horizontal-list'>
        <div class="horizontal-list-item vertical-item-and-text">
          <label for="min-number-input">Min</label>
          <input id="min-number-input" type="number" value="0" />
        </div>
        <div class="horizontal-list-item vertical-item-and-text">
          <label for="max-number-input">Max</label>
          <input id="max-number-input" type="number" value="100" />
        </div>
        <div class="horizontal-list-item vertical-item-and-text">
          <label for="precision-number-input">Decimals</label>
          <input id="precision-number-input" type="number" value="0" min="0" max="100" />
        </div>
      </div>
    </div>
    <div id='options-section-dates'>
      <div class='horizontal-list'>
        <div class="horizontal-list-item vertical-item-and-text">
          <label for="min-date-input">Min</label>
          <input id="min-date-input" type="date" value="2021-01-01" />
        </div>
        <div class="horizontal-list-item vertical-item-and-text">
          <label for="max-date-input">Max</label>
          <input id="max-date-input" type="date" value="2021-12-31" />
        </div>
      </div>
      <div class="horizontal-list-item vertical-item-and-text margin-above">
        <label for="format-date-input">Format</label>
        <input id="format-date-input" type="text" placeholder="MM/DD/YYYY" value="MM/DD/YYYY" />
      </div>
      <p class="meta">DD = 31; dddd = Monday; ddd = Mon; mmmm = January; mmm = Jan; MM = 1; YYYY = 2021</p>
    </div>
    <div id='options-section-concat' class='margin-above'>
      <div class='horizontal-list'>
        <div class="horizontal-list-item vertical-item-and-text">
          <label for="prepend-input">Prepend with</label>
          <input id="prepend-input" type="text" placeholder="Optional text" />
        </div>
        <div class="horizontal-list-item vertical-item-and-text">
          <label for="append-input">Append with</label>
          <input id="append-input" type="text" placeholder="Optional text" />
        </div>
      </div>
    </div>
  </div>

  <br>

  <div class='buttons'>
    <button id="cancel-button">Cancel</button>
    <button id="confirm-button" class='primary'>Paste</button>
  </div>

  <div id='settings-overlay' class='overlay'>
    <h2>Urls</h2>
    <div id='settings-urls-list' class='vertical-list'></div>
    <p id="settings-error-label" class="error">Error fetching data from this url.</p>

    <h2>Rules</h2>
    <p>Each JSON file listed above must follow this format:</p>
    <pre id='settings-index-code-example'></pre>

    <div class='buttons'>
      <button id="settings-back-button">Back</button>
    </div>
  </div>
</body>

<script>
  const nodesDropdown = document.getElementById('nodes-dropdown');
  const inputDropdown = document.getElementById('input-dropdown');

  const optionsSectionStrings = document.getElementById('options-section-strings');
  const optionsSectionNumbers = document.getElementById('options-section-numbers');
  const optionsSectionDates = document.getElementById('options-section-dates');
  
  const randomizeCheckbox = document.getElementById('randomize-checkbox');
  const casingDropdown = document.getElementById('casing-dropdown');

  const minNumberInput = document.getElementById('min-number-input');
  const maxNumberInput = document.getElementById('max-number-input');
  const precisionNumberInput = document.getElementById('precision-number-input');

  const minDateInput = document.getElementById('min-date-input');
  const maxDateInput = document.getElementById('max-date-input');
  const formatDateInput = document.getElementById('format-date-input');
  
  const prependInput = document.getElementById('prepend-input');
  const appendInput = document.getElementById('append-input');

  const settingsButton = document.getElementById('settings-button');
  const settingsOverlay = document.getElementById('settings-overlay');
  const settingsUrlsList = document.getElementById('settings-urls-list');
  const settingsErrorLabel = document.getElementById('settings-error-label');
  const settingsIndexCodeExample = document.getElementById('settings-index-code-example');
  const settingsBackButton = document.getElementById('settings-back-button');

  const confirmButton = document.getElementById('confirm-button');
  const cancelButton = document.getElementById('cancel-button');

  settingsOverlay.hidden = true;
  confirmButton.disabled = true;

  settingsIndexCodeExample.innerHTML = `{
  "name": "Common Words",
  "lists": [
    {
      "name": "Animals",
      "url": "https://raw.githubusercontent.com/verachell/English-word-lists-miscellaneous-categories/main/wordlists/Animals.txt"
    }
    {
      "name": "Colors",
      "path": "colors.txt"
    }
  ]
}`;

  onmessage = event => {
    const msg = event.data.pluginMessage;
    const { type } = msg;

    if (type === 'init') {
      clearInputOptionSections();
      clearNodeGroupElements();
      clearSettingsUrlElements();

      const { url, nodeGroups } = msg;
      const urls = ['https://raw.githubusercontent.com/naftalibeder/figma-mock-content/main/index.json', url];

      createSettingsUrlElements(urls);
      fetchAndCreateInputElements(urls);
      createNodeGroupElements(nodeGroups);

      inputDropdown.onchange = onInputDropdownChange;
      onInputDropdownChange();
    } else if (type === 'clear') {
      clearNodeGroupElements();
      confirmButton.disabled = true;
    }
  };

  const createSettingsUrlElements = (urls) => {
    urls.forEach((u, index) => {
      const urlWrap = document.createElement('div');
      urlWrap.className = 'horizontal-item-and-text';
      settingsUrlsList.appendChild(urlWrap);

      const urlTextField = document.createElement('input');
      urlTextField.id = `settings-url-textfield-${u}`;
      urlTextField.type = 'text';
      urlTextField.placeholder = "https://mysite.com/index.json";
      urlTextField.value = u;
      urlTextField.onblur = () => {
        parent.postMessage({ pluginMessage: { type: 'url', url: urlTextField.value } }, '*');
        const urlsCopy = [...urls];
        urlsCopy[index] = urlTextField.value;
        fetchAndCreateInputElements(urlsCopy);
      };
      if (index === 0) urlTextField.disabled = true;
      urlWrap.appendChild(urlTextField);
    });
  }

  const fetchAndCreateInputElements = (urls) => {
    console.log(`Fetching from all urls: ${urls}`);

    clearInputOptionSections();

    let responses = [];
    const next = (i) => {
      fetchInputs(urls[i], i, (response) => {
        responses.push(response);
        if (i < urls.length - 1) {
          next(i + 1);
        } else {
          for (let i = 0; i < responses.length; i++) {
            const response = responses[i];
            createInputElements(response);
          }
        }
      });
    };
    next(0);
  }

  const fetchInputs = (url, index, completion) => {
    console.log(`Fetching from ${url} at index ${index}`);

    const baseUrl = url.replace('/index.json', '');

    fetch(url, (response, error) => {
      try {
        response = JSON.parse(response);
        const { name, lists } = response;
        console.log(`Fetched ${lists.length} lists from ${url}`);
        settingsErrorLabel.hidden = true;
        completion?.({ baseUrl, name, lists });
      } catch (error) {
        console.log(`Error: ${error}`);
        settingsErrorLabel.hidden = false;
        completion?.({ baseUrl });
      }
    });
  }

  const createInputElements = (response) => {
    const { baseUrl, name: sectionName, lists } = response;

    console.log(`Creating input elements from ${sectionName}`);

    if (!sectionName || !lists) return;

    const inputOptionGroup = document.createElement('optgroup');
    inputOptionGroup.label = sectionName;
    inputDropdown.appendChild(inputOptionGroup);

    lists.forEach((list, index) => {
      const { name, path, url, type } = list;

      const inputOption = document.createElement('option');
      inputOption.id = slugify(name);
      inputOption.innerHTML = name;
      inputOption.dataset.url = path ? `${baseUrl}/${path}` : url ? url : '';
      inputOption.dataset.type = type ?? 'strings';
      inputOptionGroup.appendChild(inputOption);
    });
  }

  const createNodeGroupElements = (nodeGroups) => {
    nodeGroups.forEach((nodeGroup, i) => {
      const nodes = Object.values(nodeGroup.nodesMap);
      const nodeGroupTexts = [...new Set(nodes.map(o => o.characters))];
      const fieldCountDisplay = `(${nodes.length} fields)`;
      const multipleTextValues = nodeGroupTexts.length > 1;
      
      let nodesDisplayText = '';
      if (multipleTextValues) {
        nodesDisplayText = `${nodeGroupTexts[0].slice(0, 12)}, ${nodeGroupTexts[1].slice(0, 12)}, ... ${fieldCountDisplay}`;
      } else {
        nodesDisplayText = `${nodeGroupTexts[0].slice(0, 30)} ${fieldCountDisplay}`;
      }

      const nodeOption = document.createElement('option');
      nodeOption.value = nodeGroup.key;
      nodeOption.innerHTML = nodesDisplayText;
      if (i === 0) nodeOption.selected = true;
      nodesDropdown.appendChild(nodeOption);
    });

    if (nodeGroups.length > 0) {
      confirmButton.disabled = false;
    }
  }
  
  const onInputDropdownChange = (event) => {
    optionsSectionStrings.hidden = true;
    optionsSectionNumbers.hidden = true;
    optionsSectionDates.hidden = true;
    
    if (!event) {
      optionsSectionStrings.hidden = false;
      return;
    }
    
    const type = event.target.options[event.target.selectedIndex].dataset.type;
    console.log(`Changed input: ${type}`);

    if (type === 'strings') {
      optionsSectionStrings.hidden = false;
    } else if (type === 'numbers') {
      optionsSectionNumbers.hidden = false;
    } else if (type === 'dates') {
      optionsSectionDates.hidden = false;
    }
  }

  confirmButton.onclick = () => {
    const selectedInputDropdownOption = inputOptions().filter(o => o.selected == true)[0];
    const selectedNodeDropdownOption = [...nodesDropdown.children].filter(o => o.selected == true)[0];
    const randomize = randomizeCheckbox.checked;
    const casing = casingDropdown.value;
    const prepend = prependInput.value;
    const append = appendInput.value;

    console.log(`Selected: ${selectedInputDropdownOption.id} with casing ${casing}`);

    const config = {
      type: 'confirm',
      items: [],
      groupingKey: selectedNodeDropdownOption.value,
      randomize,
      casing,
      prepend,
      append,
    };

    const inputUrl = selectedInputDropdownOption.dataset.url;
    const inputType = selectedInputDropdownOption.dataset.type;

    if (inputUrl.length > 0) {
      console.log('Fetching:', inputUrl);
      fetch(inputUrl, (response) => {
        const items = itemsFromStr(response);
        parent.postMessage({ pluginMessage: { ...config, items } }, '*');
      });
    } else if (inputType === 'numbers') {
      const items = [];
      for (let i = 0; i < 1000; i++) {
        items.push(`${randomNumberString(minNumberInput.value, maxNumberInput.value, precisionNumberInput.value)}`);
      }
      parent.postMessage({ pluginMessage: { ...config, items } }, '*');
    } else if (inputType === 'dates') {
      const items = [];
      const minDate = new Date(minDateInput.value).getTime();
      const maxDate = new Date(maxDateInput.value).getTime();
      const format = formatDateInput.value;
      console.log(`Date: ${minDate} to ${maxDate}, ${format}`);
      for (let i = 0; i < 1000; i++) {
        items.push(`${randomDateString(minDate, maxDate, format)}`);
      }
      parent.postMessage({ pluginMessage: { ...config, items } }, '*');
    }
  };

  cancelButton.onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
  };

  settingsButton.onclick = () => {
    settingsOverlay.hidden = false;
  };

  settingsBackButton.onclick = () => {
    settingsOverlay.hidden = true;
  };

  const fetch = (url, onResponse, onError) => {
    let request = new XMLHttpRequest();
    request.open('GET', url);
    request.responseType = 'text';
    request.onload = () => onResponse(request.response);
    request.onerror = onError;
    request.send();
  }

  const itemsFromStr = (str) => {
    return str.split('\n').filter(line => line.length > 0);
  }

  const inputOptions = () => {
    let o = [];
    for (let i = 0; i < inputDropdown.children.length; i++) {
      const section = inputDropdown.children[i];
      for (let i = 0; i < section.children.length; i++) {
        const option = section.children[i];
        o.push(option);
      }
    }
    return o;
  }

  const clearInputOptionSections = () => {
    while (inputDropdown.firstChild) {
      inputDropdown.removeChild(inputDropdown.firstChild);
    }
  }

  const clearNodeGroupElements = () => {
    while (nodesDropdown.firstChild) {
      nodesDropdown.removeChild(nodesDropdown.firstChild);
    }
  }

  const clearSettingsUrlElements = () => {
    while (settingsUrlsList.firstChild) {
      settingsUrlsList.removeChild(settingsUrlsList.firstChild);
    }
  }

  const randomNumberString = (min, max, precision) => {
    return Math.floor(Math.random() * (max - min + 1) + min).toFixed(precision);
  }

  const randomDateString = (min, max, format) => {
    const randDate = new Date(min + Math.random() * (max - min));
    return format
    .replace('DD', randDate.getDate())
    .replace('dddd', randDate.toLocaleString("default", { weekday: "long" }))
    .replace('ddd', randDate.toLocaleString("default", { weekday: "short" }))
    .replace('mmmm', randDate.toLocaleString("default", { month: "long" }))
    .replace('mmm', randDate.toLocaleString("default", { month: "short" }))
    .replace('MM', randDate.getMonth() + 1)
    .replace('YYYY', randDate.getFullYear());
  }

  const slugify = (text) => {
    return text.replace(' ', '-').toLowerCase();
  }

  parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
</script>